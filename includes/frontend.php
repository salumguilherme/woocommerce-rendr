<?php

	namespace WcRendr;

	/**
	 * Class Frontend
	 *
	 * @version 1.0.0
	 * @since   1.0.0
	 * @package WcRendr
	 */
	class Frontend {

		/**
		 * Frontend constructor.
		 */
		public function __construct() {

			add_action('woocommerce_after_shipping_rate', [$this, 'method_description'], 10, 2);

		}

		/**
		 * method_description function
		 *
		 * @version 1.0.0
		 * @since   1.0.0
		 *
		 * @param \WC_Shipping_Rate $rate
		 * @param                   $index
		 */
		public function method_description(\WC_Shipping_Rate $rate, $index) {

			$meta = $rate->get_meta_data();

			if(empty($meta['delivery_from']) || empty($meta['delivery_to']) || (empty($meta['num_days']) && $meta['num_days'] != 0)) {
				return;
			}

			try {

				$delivery_from = new \DateTime($meta['delivery_from']);
				$today = new \DateTime('now', new \DateTimeZone(get_option('timezone_string')));
				$tomorrow = new \DateTime('tomorrow', new \DateTimeZone(get_option('timezone_string')));
				$delivery_to = new \DateTime($meta['delivery_to']);

				if($delivery_from->format('Ymd') != $delivery_to->format('Ymd')) {

					$delivery_text = sprintf(__('Delivered by <strong>%s</strong>', 'wcrendr'), $delivery_to->format('l'));

				} else {

					$hour = clone $delivery_to;
					if($delivery_to->format('i') > 0) {
						$hour->modify('+1 hour');
					}
					$hour = $hour->format('g').$hour->format('a');

					if($meta['type'] == 'flexible') {
						$hour = '5pm';
					}

					if($delivery_to->format('Ymd') == $today->format('Ymd')) {
						$delivery_text = sprintf(__('Delivered <strong>Today</strong> by <strong>%s</strong>', 'wcrendr'), $hour);
					} else if($delivery_to->format('Ymd') == $tomorrow->format('Ymd')) {
						$delivery_text = sprintf(__('Delivered by <strong>Tomorrow</strong> <strong>%s</strong>', 'wcrendr'), $hour);
					} else {
						$delivery_text = sprintf(__('Delivered by <strong>%s</strong>', 'wcrendr'), $delivery_to->format('l'));
					}
				}

			} catch(\Exception $e) {

				return;

			}

			ob_start(); ?>
			<div class="wcrendr-rate-description">
				<small><?php echo $delivery_text ?></small>
			</div>

			<?php
			if(WcRendr()->admin->get_method()->get_option('disable_brand') !== 'yes') {
			$has_rendr = false;

			$chosen_method = isset($_POST['shipping_method']) ? $_POST['shipping_method'] : wc_get_chosen_shipping_method_ids();

			foreach($chosen_method as $smethoid) {
				if(strpos($smethoid, 'wcrendr') !== false) {
					$has_rendr = true; break;
				}
			}
			if($has_rendr) {
				?>
				<style type="text/css">
					input.shipping_method:checked + label + .wcrendr-rate-description {
						padding-bottom: 35px !important;
                        position: relative;
                    }
                    input.shipping_method:checked + label + .wcrendr-rate-description:after {
						content: '';
						width: 100%;
						height: 16px;
						display: block;
						background: transparent url('data:image/svg+xml;utf-8,<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2044 188"><path d="M1513.24 170.232c2.01 3.439-.48 7.76-4.47 7.76h-37.49a5.145 5.145 0 01-4.5-2.626l-26.39-46.755h-28.14l-8.03 45.131a5.204 5.204 0 01-5.1 4.25h-31.94c-3.23 0-5.67-2.889-5.1-6.065L1377 87.513a8.27 8.27 0 018.15-6.827h35.55l-2.08 11.796c-.58 3.39 2.96 5.97 6 4.37l23.76-12.418 24.91-13.037c2.79-1.456 2.96-5.42.31-7.14l-19.48-12.488-20.24-12.966c-2.49-1.576-5.79-.143-6.29 2.77l-2.32 13.23h-32.62c-5.15 0-9.05-4.639-8.16-9.698l5.9-33.332c.45-2.46 2.58-4.274 5.09-4.274h67.02c39.42 0 64.54 18.816 64.54 51.148 0 27.34-16.84 50.408-42.7 61.942l28.9 49.643zm84.38-116.6c-37.68 0-69.07 26.577-75.34 63.446-6.29 36.343 16.06 63.685 55.75 63.685 28.59 0 51.87-13.516 63.28-34.888 1.44-2.721-.62-5.993-3.71-5.993h-30.69c-2.25 0-4.34.991-5.97 2.543-4.09 3.886-10 5.982-17.12 5.982-14.33 0-21.87-8.262-23.38-19.294h79.68c3.84 0 7.17-2.617 8.05-6.347.55-2.313 1.15-5.084 1.7-8.196 5.79-36.845-16.31-60.938-52.25-60.938zm16.34 51.649h-50c5.29-12.536 15.07-20.798 29.41-20.798 13.06 0 21.34 6.28 20.59 20.798zm131.38-52.629c-13.07 0-24.36 4.251-35.68 11.773l.36-1.91c.6-3.176-1.84-6.113-5.07-6.113h-30.12a5.19 5.19 0 00-3.33 1.213 5.173 5.173 0 00-1.77 3.061l-19.54 111.275c-.55 3.153 1.89 6.042 5.09 6.042h30.2a5.2 5.2 0 003.33-1.207 5.171 5.171 0 001.76-3.067l12.56-72.186c8.54-8.023 17.08-12.035 24.62-12.035 13.33 0 20.86 8.262 17.59 25.574l-9.98 56.879c-.58 3.153 1.86 6.043 5.09 6.043h30.44a5.18 5.18 0 003.33-1.208 5.115 5.115 0 001.76-3.067l11.32-65.165c6.03-34.6-11.05-55.901-41.96-55.901zM1946.9 0h-30.41a5.196 5.196 0 00-3.33 1.208 5.168 5.168 0 00-1.76 3.066l-10.31 58.909c-8.04-5.54-18.33-9.05-31.66-9.05-36.91 0-72.85 32.092-72.85 73.212 0 30.851 21.1 53.655 50.51 53.655 6.65 0 12.8-.883 18.56-2.435 5.75-1.576 11.08-3.845 16.11-6.591a5.155 5.155 0 005.09 6.017h30.24c2.51 0 4.67-1.79 5.1-4.251L1952 6.064c.57-3.174-1.87-6.064-5.1-6.064zm-58.88 136.635c-9.04 8.525-18.32 11.032-27.13 11.032-14.57 0-23.85-11.032-23.85-25.336 0-19.055 15.81-35.1 34.67-35.1 8.78 0 17.08 2.769 23.11 11.293l-6.8 38.111zm155.9-75.935l-4.96 28.272c-.4 2.317-2.32 4.084-4.66 4.25-17.94 1.266-30.46 6.449-40.77 15.331l-4.02 22.733-7.08 39.901c-.69 3.94-4.14 6.806-8.13 6.806h-23.9c-5.15 0-9.05-4.632-8.16-9.67l.59-3.392c0-.071 0-.143.03-.214l10.81-61.607 7.61-43.293c.17-.958.68-1.824 1.42-2.448.75-.624 1.7-.966 2.67-.966h27.42c5.14 0 9.04 4.632 8.16 9.67l-.6 3.39-.02.216c5.38-4.178 11.17-7.617 17.49-10.172 6.31-2.555 13.15-4.227 20.69-4.848 3.33-.262 6 2.77 5.41 6.041z" fill="%233DABC0"/><path d="M.212 56.44V153h34.932c29.678 0 51.12-20.448 51.12-48.848 0-27.69-21.442-47.712-51.12-47.712H.212zm13.49 84.064V68.936h21.442c21.442 0 37.204 15.052 37.204 35.216 0 21.016-15.762 36.352-37.204 36.352H13.702zM163.301 119.204c-.142-20.022-13.632-34.222-32.376-34.222-20.732 0-34.79 15.194-34.79 34.932 0 19.596 14.058 34.79 34.79 34.79 14.91 0 26.838-7.526 30.672-19.312h-14.058c-2.698 5.112-8.378 8.236-16.188 8.236-12.922 0-20.448-8.378-22.294-18.744h53.676v-.142l.284.142c.284-1.846.284-3.834.284-5.68zM130.357 96.2c11.218 0 18.46 7.526 19.738 18.886h-41.038c1.704-10.65 9.23-18.886 21.3-18.886zM191.026 52.18h-13.064V153h13.064V52.18zM217.884 70.214c4.686 0 8.52-3.55 8.52-8.236 0-4.686-3.834-8.236-8.52-8.236-4.828 0-8.52 3.55-8.52 8.236 0 4.686 3.692 8.236 8.52 8.236zm6.532 16.472h-12.922V153h12.922V86.686zM309.335 86.686h-13.916l-23.004 49.7-23.146-49.7h-13.774L266.593 153h11.644l31.098-66.314zM379.086 119.204c-.142-20.022-13.632-34.222-32.376-34.222-20.732 0-34.79 15.194-34.79 34.932 0 19.596 14.058 34.79 34.79 34.79 14.91 0 26.838-7.526 30.672-19.312h-14.058c-2.698 5.112-8.378 8.236-16.188 8.236-12.922 0-20.448-8.378-22.294-18.744h53.676v-.142l.284.142c.284-1.846.284-3.834.284-5.68zM346.142 96.2c11.218 0 18.46 7.526 19.738 18.886h-41.038c1.704-10.65 9.23-18.886 21.3-18.886zM406.117 86.686h-13.064V153h13.064v-42.458c5.964-8.236 14.342-12.78 24.992-13.064V85.124c-10.366 0-18.886 4.26-24.992 11.36v-9.798zM513.621 86.544h-13.774l-24.14 54.102-26.128-54.102h-14.058l33.512 69.296-14.058 31.524h13.774l44.872-100.82zM589.483 84.982c-8.946 0-16.472 2.84-22.152 7.668v-5.964h-13.064v100.82h13.064v-40.47c5.68 4.828 13.206 7.668 22.152 7.668 18.744 0 33.938-15.478 33.938-34.79 0-19.454-15.194-34.932-33.938-34.932zm-1.846 58.362c-7.952 0-15.194-3.266-20.306-10.792v-25.418c5.112-7.526 12.354-10.792 20.306-10.792 12.922 0 22.72 10.792 22.72 23.572 0 12.496-9.798 23.43-22.72 23.43zM669.773 84.982c-20.164 0-35.358 14.91-35.358 34.932 0 20.022 15.194 35.216 35.358 35.216 19.88 0 35.216-15.194 35.216-35.216s-15.336-34.932-35.216-34.932zm0 58.22c-13.064 0-22.294-10.366-22.294-23.288 0-12.78 9.23-23.004 22.294-23.004 12.78 0 22.01 10.224 22.01 23.004 0 12.922-9.23 23.288-22.01 23.288zM812.808 86.686H798.75l-16.614 45.724-15.62-45.724h-11.218l-15.62 45.724-16.472-45.724h-14.058L733.998 153h11.644l15.336-45.298L776.314 153h11.644l24.85-66.314zM884.356 119.204c-.142-20.022-13.632-34.222-32.376-34.222-20.732 0-34.79 15.194-34.79 34.932 0 19.596 14.058 34.79 34.79 34.79 14.91 0 26.838-7.526 30.672-19.312h-14.058c-2.698 5.112-8.378 8.236-16.188 8.236-12.922 0-20.448-8.378-22.294-18.744h53.676v-.142l.284.142c.284-1.846.284-3.834.284-5.68zM851.412 96.2c11.218 0 18.46 7.526 19.738 18.886h-41.038c1.704-10.65 9.23-18.886 21.3-18.886zM911.387 86.686h-13.064V153h13.064v-42.458c5.964-8.236 14.342-12.78 24.992-13.064V85.124c-10.366 0-18.886 4.26-24.992 11.36v-9.798zM1009.72 119.204c-.14-20.022-13.631-34.222-32.375-34.222-20.732 0-34.79 15.194-34.79 34.932 0 19.596 14.058 34.79 34.79 34.79 14.91 0 26.835-7.526 30.675-19.312h-14.061c-2.698 5.112-8.378 8.236-16.188 8.236-12.922 0-20.448-8.378-22.294-18.744h53.673v-.142l.29.142c.28-1.846.28-3.834.28-5.68zM976.777 96.2c11.218 0 18.46 7.526 19.738 18.886h-41.038c1.704-10.65 9.23-18.886 21.3-18.886zM1089.71 52.18h-13.06v40.328c-5.68-4.828-13.35-7.526-22.15-7.526-18.75 0-33.8 15.478-33.8 34.79 0 19.312 15.05 34.79 33.8 34.79 8.8 0 16.47-2.698 22.15-7.526V153h13.06V52.18zm-33.37 91.164c-12.92 0-22.58-10.934-22.58-23.572s9.66-23.43 22.58-23.43c7.95 0 15.2 3.124 20.31 10.65v25.702c-5.11 7.384-12.36 10.65-20.31 10.65zM1178.72 84.982c-8.94 0-16.47 2.84-22.15 7.526V52.18h-13.06V153h13.06v-5.964c5.68 4.686 13.21 7.526 22.15 7.526 18.75 0 33.94-15.478 33.94-34.79 0-19.312-15.19-34.79-33.94-34.79zm-1.84 58.362c-7.96 0-15.2-3.408-20.31-10.792v-25.418c5.11-7.526 12.35-10.792 20.31-10.792 12.92 0 22.72 10.792 22.72 23.43s-9.8 23.572-22.72 23.572zM1292.92 86.544h-13.78L1255 140.646l-26.12-54.102h-14.06l33.51 69.296-14.06 31.524h13.78l44.87-100.82z" fill="%2312273E"/></svg>') no-repeat 50% / contain;
                        position: absolute;
	                    left: 0;
	                    bottom: 12px;

                                                  }
                    .woocommerce-checkout input.shipping_method:checked + label + .wcrendr-rate-description:after {
	                    left: auto; right: 0;
                        background-position: top right
                    }
				</style>
				<?php
			}
			}
			$markup = ob_get_clean();
			echo apply_filters('wcrendr_rate_description', $markup, $rate, $index);

		}

	}